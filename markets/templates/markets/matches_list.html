{% extends 'markets/base.html' %}

{% block title %}Market Matches - Arbitrage Analyzer{% endblock %}

{% block content %}
<div class="section-header">
    <h2>Cross-Exchange Market Matches</h2>
</div>

<div class="filter-bar">
    <select id="verifiedFilter" onchange="applyFilters()">
        <option value="">All Matches</option>
        <option value="true" {% if verified_filter == 'true' %}selected{% endif %}>Verified Only</option>
        <option value="false" {% if verified_filter == 'false' %}selected{% endif %}>Unverified Only</option>
    </select>
    <span class="page-info">{{ total_count }} matches total</span>
</div>

{% if matches %}
<table>
    <thead>
        <tr>
            <th>Kalshi Market</th>
            <th>Polymarket Market</th>
            <th class="sortable {% if current_sort == 'similarity_score' %}asc{% elif current_sort == '-similarity_score' %}desc{% endif %}"
                onclick="sortBy('similarity_score')">Similarity</th>
            <th>Match Reason</th>
            <th class="sortable {% if current_sort == 'is_verified' %}asc{% elif current_sort == '-is_verified' %}desc{% endif %}"
                onclick="sortBy('is_verified')">Status</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        {% for match in matches %}
        <tr id="match-{{ match.id }}">
            <td>
                <a href="{{ match.kalshi_market.url }}" target="_blank">
                    {{ match.kalshi_market.title|truncatechars:40 }}
                </a>
                <div class="positions-list" style="margin-top: 5px;">
                    {% for outcome in match.kalshi_market.outcomes %}
                    <span>{{ outcome.name }}: {{ outcome.price|floatformat:2 }}</span>
                    {% endfor %}
                </div>
            </td>
            <td>
                <a href="{{ match.polymarket_market.url }}" target="_blank">
                    {{ match.polymarket_market.title|truncatechars:40 }}
                </a>
                <div class="positions-list" style="margin-top: 5px;">
                    {% for outcome in match.polymarket_market.outcomes %}
                    <span>{{ outcome.name }}: {{ outcome.price|floatformat:2 }}</span>
                    {% endfor %}
                </div>
            </td>
            <td>
                {% if match.similarity_score >= 0.8 %}
                <span class="similarity high">{% widthratio match.similarity_score 1 100 %}%</span>
                {% elif match.similarity_score >= 0.7 %}
                <span class="similarity medium">{% widthratio match.similarity_score 1 100 %}%</span>
                {% else %}
                <span class="similarity low">{% widthratio match.similarity_score 1 100 %}%</span>
                {% endif %}
            </td>
            <td class="match-reason">
                {{ match.match_reason }}
            </td>
            <td id="status-{{ match.id }}">
                {% if match.is_verified %}
                <span style="color: #22c55e;">Verified</span>
                {% else %}
                <span style="color: #888;">Unverified</span>
                {% endif %}
            </td>
            <td>
                <button
                    class="btn verify-btn {% if match.is_verified %}verified{% endif %}"
                    onclick="toggleVerify({{ match.id }})"
                    id="btn-{{ match.id }}"
                >
                    {% if match.is_verified %}Unverify{% else %}Verify{% endif %}
                </button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<!-- Pagination -->
{% if matches.has_other_pages %}
<div class="pagination">
    {% if matches.has_previous %}
    <a href="?page=1&verified={{ verified_filter }}&sort={{ current_sort }}">First</a>
    <a href="?page={{ matches.previous_page_number }}&verified={{ verified_filter }}&sort={{ current_sort }}">Prev</a>
    {% else %}
    <span class="disabled">First</span>
    <span class="disabled">Prev</span>
    {% endif %}

    {% for num in matches.paginator.page_range %}
        {% if matches.number == num %}
        <span class="current">{{ num }}</span>
        {% elif num > matches.number|add:'-3' and num < matches.number|add:'3' %}
        <a href="?page={{ num }}&verified={{ verified_filter }}&sort={{ current_sort }}">{{ num }}</a>
        {% endif %}
    {% endfor %}

    {% if matches.has_next %}
    <a href="?page={{ matches.next_page_number }}&verified={{ verified_filter }}&sort={{ current_sort }}">Next</a>
    <a href="?page={{ matches.paginator.num_pages }}&verified={{ verified_filter }}&sort={{ current_sort }}">Last</a>
    {% else %}
    <span class="disabled">Next</span>
    <span class="disabled">Last</span>
    {% endif %}
</div>
{% endif %}

{% else %}
<div class="empty-state">
    <p>No market matches found.</p>
    <p>Sync markets from the dashboard to find cross-exchange matches.</p>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    const currentSort = '{{ current_sort }}';
    const verifiedFilter = '{{ verified_filter }}';

    function sortBy(column) {
        let newSort = column;
        // Toggle direction
        if (currentSort === column) {
            newSort = '-' + column;
        } else if (currentSort === '-' + column) {
            newSort = column;
        } else {
            newSort = '-' + column; // Default to descending
        }
        applyFilters(newSort);
    }

    function applyFilters(sort = null) {
        const verified = document.getElementById('verifiedFilter').value;
        const params = new URLSearchParams();
        if (verified) params.set('verified', verified);
        params.set('sort', sort || currentSort);
        window.location.href = '?' + params.toString();
    }

    async function toggleVerify(matchId) {
        const btn = document.getElementById('btn-' + matchId);
        const status = document.getElementById('status-' + matchId);

        btn.disabled = true;

        try {
            const response = await fetch(`/api/verify/${matchId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                }
            });

            const data = await response.json();

            if (data.success) {
                if (data.is_verified) {
                    btn.textContent = 'Unverify';
                    btn.classList.add('verified');
                    status.innerHTML = '<span style="color: #22c55e;">Verified</span>';
                    showToast('Match verified successfully');
                } else {
                    btn.textContent = 'Verify';
                    btn.classList.remove('verified');
                    status.innerHTML = '<span style="color: #888;">Unverified</span>';
                    showToast('Match unverified');
                }
            } else {
                showToast('Error: ' + data.error, 'error');
            }
        } catch (e) {
            showToast('Network error: ' + e.message, 'error');
        } finally {
            btn.disabled = false;
        }
    }
</script>
{% endblock %}
