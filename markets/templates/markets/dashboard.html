{% extends 'markets/base.html' %}

{% block title %}Dashboard - Arbitrage Analyzer{% endblock %}

{% block content %}
<div class="stats-grid">
    <div class="stat-card">
        <h3>Opportunities</h3>
        <div class="value green">{{ total_opportunities }}</div>
    </div>
    <div class="stat-card">
        <h3>Kalshi Markets</h3>
        <div class="value">{{ kalshi_count }}</div>
    </div>
    <div class="stat-card">
        <h3>Polymarket Markets</h3>
        <div class="value">{{ poly_count }}</div>
    </div>
    <div class="stat-card">
        <h3>Cross-Exchange Matches</h3>
        <div class="value">{{ match_count }}</div>
    </div>
</div>

<div class="section-header">
    <h2>Sync Markets</h2>
    <button class="btn" onclick="loadTags()" id="loadTagsBtn">
        Load Tags
        <span class="loading" id="loadTagsLoading">...</span>
    </button>
</div>

<div class="tag-filters">
    <div class="tag-filter-section">
        <h3>Kalshi Tags</h3>
        <p class="filter-hint">No tags selected = fetch all markets</p>
        <div class="tag-select-container" id="kalshiTagsContainer">
            <div class="tag-checkboxes" id="kalshiTags">
                <span class="no-tags">Click "Load Tags" to see available tags</span>
            </div>
        </div>
    </div>
    <div class="tag-filter-section">
        <h3>Polymarket Tags</h3>
        <p class="filter-hint">No tags selected = fetch all markets</p>
        <div class="tag-select-container" id="polymarketTagsContainer">
            <div class="tag-checkboxes" id="polymarketTags">
                <span class="no-tags">Click "Load Tags" to see available tags</span>
            </div>
        </div>
    </div>
</div>

<div class="section-header">
    <h2>Actions</h2>
    <div>
        <button class="btn primary" onclick="syncMarkets()" id="syncBtn">
            Sync Markets
            <span class="loading" id="syncLoading">...</span>
        </button>
        <button class="btn" onclick="refreshOpportunities()" id="refreshBtn">
            Refresh Opportunities
            <span class="loading" id="refreshLoading">...</span>
        </button>
    </div>
</div>

<div class="section-header">
    <h2>All Arbitrage Opportunities</h2>
    <span class="page-info">{{ total_opportunities }} total</span>
</div>

{% if opportunities %}
<table>
    <thead>
        <tr>
            <th>Kalshi Market</th>
            <th>Polymarket Market</th>
            <th>Positions</th>
            <th class="sortable {% if current_sort == 'profit_percent' %}asc{% elif current_sort == '-profit_percent' %}desc{% endif %}"
                onclick="sortBy('profit_percent')">Profit %</th>
            <th class="sortable {% if current_sort == 'expected_value' %}asc{% elif current_sort == '-expected_value' %}desc{% endif %}"
                onclick="sortBy('expected_value')">EV</th>
            <th class="sortable {% if current_sort == 'arb_type' %}asc{% elif current_sort == '-arb_type' %}desc{% endif %}"
                onclick="sortBy('arb_type')">Type</th>
        </tr>
    </thead>
    <tbody>
        {% for opp in opportunities %}
        <tr>
            {% if opp.arb_type == 'cross_exchange' %}
            <td>
                <a href="{{ opp.market_match.kalshi_market.url }}" target="_blank">
                    {{ opp.market_match.kalshi_market.title|truncatechars:50 }}
                </a>
            </td>
            <td>
                <a href="{{ opp.market_match.polymarket_market.url }}" target="_blank">
                    {{ opp.market_match.polymarket_market.title|truncatechars:50 }}
                </a>
            </td>
            {% elif opp.arb_type == 'kalshi_only' %}
            <td>
                {% for market in opp.markets.all %}
                <a href="{{ market.url }}" target="_blank">
                    {{ market.title|truncatechars:50 }}
                </a>
                {% endfor %}
            </td>
            <td class="same-exchange">
                <span class="badge kalshi">Same exchange (Kalshi)</span>
            </td>
            {% elif opp.arb_type == 'polymarket_only' %}
            <td class="same-exchange">
                <span class="badge polymarket">Same exchange (Polymarket)</span>
            </td>
            <td>
                {% for market in opp.markets.all %}
                <a href="{{ market.url }}" target="_blank">
                    {{ market.title|truncatechars:50 }}
                </a>
                {% endfor %}
            </td>
            {% endif %}
            <td class="positions-list">
                {% for pos in opp.positions.positions %}
                <div class="position">
                    {% if opp.arb_type == 'cross_exchange' %}
                    <span class="exchange-badge {{ pos.exchange }}">{{ pos.exchange }}</span>
                    {% endif %}
                    {{ pos.outcome }} @ {{ pos.price|floatformat:2 }}
                </div>
                {% endfor %}
            </td>
            <td class="profit {% if opp.profit_percent > 5 %}high{% endif %}">
                +{{ opp.profit_percent|floatformat:2 }}%
            </td>
            <td>{{ opp.expected_value|floatformat:3 }}</td>
            <td>
                {% if opp.arb_type == 'cross_exchange' %}
                <span class="type-badge cross">Cross</span>
                {% if opp.market_match.is_verified %}
                <span style="color: #22c55e; font-size: 0.8em;">âœ“</span>
                {% endif %}
                {% elif opp.arb_type == 'kalshi_only' %}
                <span class="type-badge kalshi">Kalshi</span>
                {% else %}
                <span class="type-badge poly">Poly</span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Pagination -->
{% if opportunities.has_other_pages %}
<div class="pagination">
    {% if opportunities.has_previous %}
    <a href="?page=1&sort={{ current_sort }}">First</a>
    <a href="?page={{ opportunities.previous_page_number }}&sort={{ current_sort }}">Prev</a>
    {% else %}
    <span class="disabled">First</span>
    <span class="disabled">Prev</span>
    {% endif %}

    {% for num in opportunities.paginator.page_range %}
        {% if opportunities.number == num %}
        <span class="current">{{ num }}</span>
        {% elif num > opportunities.number|add:'-3' and num < opportunities.number|add:'3' %}
        <a href="?page={{ num }}&sort={{ current_sort }}">{{ num }}</a>
        {% endif %}
    {% endfor %}

    {% if opportunities.has_next %}
    <a href="?page={{ opportunities.next_page_number }}&sort={{ current_sort }}">Next</a>
    <a href="?page={{ opportunities.paginator.num_pages }}&sort={{ current_sort }}">Last</a>
    {% else %}
    <span class="disabled">Next</span>
    <span class="disabled">Last</span>
    {% endif %}
</div>
{% endif %}

{% else %}
<div class="empty-state">
    <p>No arbitrage opportunities found.</p>
    <p>Click "Sync Markets" to fetch latest data from exchanges.</p>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    const currentSort = '{{ current_sort }}';
    let tagsLoaded = false;

    function sortBy(column) {
        let newSort = column;
        if (currentSort === column) {
            newSort = '-' + column;
        } else if (currentSort === '-' + column) {
            newSort = column;
        } else {
            newSort = '-' + column;
        }
        window.location.href = '?sort=' + newSort;
    }

    async function loadTags() {
        const btn = document.getElementById('loadTagsBtn');
        const loading = document.getElementById('loadTagsLoading');

        btn.disabled = true;
        loading.style.display = 'inline';

        try {
            const response = await fetch('{% url "markets:get_tags" %}');
            const data = await response.json();

            if (data.success) {
                renderKalshiTags(data.kalshi);
                renderPolymarketTags(data.polymarket);
                tagsLoaded = true;
                showToast(`Loaded ${data.kalshi.length} Kalshi tags, ${data.polymarket.length} Polymarket tags`);
            } else {
                showToast('Error loading tags: ' + data.error, 'error');
            }
        } catch (e) {
            showToast('Network error: ' + e.message, 'error');
        } finally {
            btn.disabled = false;
            loading.style.display = 'none';
        }
    }

    function renderKalshiTags(tags) {
        const container = document.getElementById('kalshiTags');
        if (!tags || tags.length === 0) {
            container.innerHTML = '<span class="no-tags">No tags available</span>';
            return;
        }

        // Group tags by category
        const byCategory = {};
        tags.forEach(tag => {
            const cat = tag.category || 'Other';
            if (!byCategory[cat]) byCategory[cat] = [];
            byCategory[cat].push(tag);
        });

        let html = '';
        for (const [category, categoryTags] of Object.entries(byCategory)) {
            html += `<div class="tag-category">
                <span class="category-label">${category}</span>
                <div class="category-tags">`;
            categoryTags.forEach(tag => {
                html += `<label class="tag-checkbox">
                    <input type="checkbox" name="kalshi_tag" value="${tag.id}">
                    <span class="tag-label">${tag.label}</span>
                    <span class="tag-count">(${tag.count})</span>
                </label>`;
            });
            html += '</div></div>';
        }
        container.innerHTML = html;
    }

    function renderPolymarketTags(tags) {
        const container = document.getElementById('polymarketTags');
        if (!tags || tags.length === 0) {
            container.innerHTML = '<span class="no-tags">No tags available</span>';
            return;
        }

        let html = '<div class="category-tags">';
        tags.forEach(tag => {
            html += `<label class="tag-checkbox">
                <input type="checkbox" name="polymarket_tag" value="${tag.id}">
                <span class="tag-label">${tag.label}</span>
            </label>`;
        });
        html += '</div>';
        container.innerHTML = html;
    }

    function getSelectedTags() {
        const kalshiTags = [];
        const polymarketTags = [];

        document.querySelectorAll('input[name="kalshi_tag"]:checked').forEach(cb => {
            kalshiTags.push(cb.value);
        });

        document.querySelectorAll('input[name="polymarket_tag"]:checked').forEach(cb => {
            polymarketTags.push(cb.value);
        });

        return { kalshiTags, polymarketTags };
    }

    async function syncMarkets() {
        const btn = document.getElementById('syncBtn');
        const loading = document.getElementById('syncLoading');

        btn.disabled = true;
        loading.style.display = 'inline';

        try {
            const { kalshiTags, polymarketTags } = getSelectedTags();

            const body = {};
            if (kalshiTags.length > 0) {
                body.kalshi_tags = kalshiTags;
            }
            if (polymarketTags.length > 0) {
                body.polymarket_tags = polymarketTags;
            }

            const response = await fetch('{% url "markets:sync_markets" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });

            const data = await response.json();

            if (data.success) {
                let msg = `Synced: ${data.kalshi_synced} Kalshi, ${data.polymarket_synced} Polymarket markets`;
                if (kalshiTags.length > 0 || polymarketTags.length > 0) {
                    msg += ' (filtered by tags)';
                }
                showToast(msg);
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast('Error: ' + data.error, 'error');
            }
        } catch (e) {
            showToast('Network error: ' + e.message, 'error');
        } finally {
            btn.disabled = false;
            loading.style.display = 'none';
        }
    }

    async function refreshOpportunities() {
        const btn = document.getElementById('refreshBtn');
        const loading = document.getElementById('refreshLoading');

        btn.disabled = true;
        loading.style.display = 'inline';

        try {
            const response = await fetch('{% url "markets:refresh_arbitrage" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                }
            });

            const data = await response.json();

            if (data.success) {
                showToast(`Found ${data.matches_found} matches, ${data.opportunities_found} opportunities`);
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast('Error: ' + data.error, 'error');
            }
        } catch (e) {
            showToast('Network error: ' + e.message, 'error');
        } finally {
            btn.disabled = false;
            loading.style.display = 'none';
        }
    }
</script>
{% endblock %}
