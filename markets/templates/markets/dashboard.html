{% extends 'markets/base.html' %}
{% load static %}

{% block title %}Dashboard - Arbitrage Analyzer{% endblock %}

{% block content %}
<div class="stats-grid">
    <div class="stat-card">
        <h3>Kalshi Events</h3>
        <div class="value">{{ kalshi_event_count }}</div>
    </div>
    <div class="stat-card">
        <h3>Polymarket Events</h3>
        <div class="value">{{ poly_event_count }}</div>
    </div>
    <div class="stat-card">
        <h3>Event Matches</h3>
        <div class="value green">{{ event_match_count }}</div>
    </div>
</div>

<!-- Event Sync Section -->
<div class="section-header">
    <h2>Event Sync</h2>
</div>
<p class="section-description">Sync events from both exchanges with optional date filtering.</p>

<div class="date-filter-section">
    <div class="date-filters">
        <div class="date-input-group">
            <label for="closeAfterDate">Closes After:</label>
            <input type="date" id="closeAfterDate" class="date-input">
        </div>
        <button class="btn-small" onclick="clearSyncFilters()">Clear</button>
    </div>
</div>

<div class="action-buttons">
    <button class="btn primary" onclick="syncEvents()" id="syncBtn">
        Sync Events
        <span class="loading" id="syncLoading">...</span>
    </button>
</div>

<!-- Events Display Section -->
<div class="section-header">
    <h2>Events</h2>
</div>
<p class="section-description">Select one event from each exchange and click "Create Match" to manually match them.</p>

<div class="events-display">
    <div class="events-column">
        <h3>Kalshi Events (<span id="kalshiCount">{{ kalshi_event_count }}</span>)</h3>
        <input type="text" id="kalshiEventSearch" placeholder="Search Kalshi events..." class="search-input">
        <div class="filter-section">
            <div class="filter-row">
                <input type="number" id="kalshiVolume24hMin" placeholder="Min 24h Vol" class="filter-input">
                <input type="number" id="kalshiVolume24hMax" placeholder="Max 24h Vol" class="filter-input">
            </div>
            <div class="filter-row">
                <input type="number" id="kalshiLiquidityMin" placeholder="Min Liquidity" class="filter-input">
                <input type="number" id="kalshiLiquidityMax" placeholder="Max Liquidity" class="filter-input">
            </div>
            <div class="filter-row">
                <input type="date" id="kalshiEndDateAfter" class="filter-input" title="End After">
                <input type="date" id="kalshiEndDateBefore" class="filter-input" title="End Before">
            </div>
            <div class="filter-actions">
                <button class="btn-small" onclick="clearFilters('kalshi')">Clear</button>
            </div>
        </div>
        <div class="events-list" id="kalshiEventsList">
            {% for event in kalshi_events %}
            <div class="event-item" data-id="{{ event.id }}" onclick="selectEvent(this, 'kalshi')">
                <div class="event-title">
                    {% if event.url %}
                        <a href="{{ event.url }}" target="_blank" onclick="event.stopPropagation()">{{ event.title }}</a>
                    {% else %}
                        {{ event.title }}
                    {% endif %}
                </div>
                {% if event.sub_title %}<div class="event-subtitle">{{ event.sub_title }}</div>{% endif %}
                {% if event.rules_primary %}<div class="event-rules">{{ event.rules_primary|truncatechars:150 }}</div>{% endif %}
                <div class="event-meta">
                    <span>24h Vol: ${{ event.volume_24h|floatformat:0 }}</span>
                    <span>Liq: ${{ event.liquidity|floatformat:0 }}</span>
                    {% if event.end_date %}<span>Ends: {{ event.end_date|slice:":10" }}</span>{% endif %}
                </div>
            </div>
            {% empty %}
            <p class="no-events">No Kalshi events synced yet. Click "Sync Events" to fetch them.</p>
            {% endfor %}
        </div>
    </div>
    <div class="events-column">
        <h3>Polymarket Events (<span id="polymarketCount">{{ poly_event_count }}</span>)</h3>
        <input type="text" id="polymarketEventSearch" placeholder="Search Polymarket events..." class="search-input">
        <div class="filter-section">
            <div class="filter-row">
                <input type="number" id="polymarketVolume24hMin" placeholder="Min 24h Vol" class="filter-input">
                <input type="number" id="polymarketVolume24hMax" placeholder="Max 24h Vol" class="filter-input">
            </div>
            <div class="filter-row">
                <input type="number" id="polymarketLiquidityMin" placeholder="Min Liquidity" class="filter-input">
                <input type="number" id="polymarketLiquidityMax" placeholder="Max Liquidity" class="filter-input">
            </div>
            <div class="filter-row">
                <input type="date" id="polymarketEndDateAfter" class="filter-input" title="End After">
                <input type="date" id="polymarketEndDateBefore" class="filter-input" title="End Before">
            </div>
            <div class="filter-actions">
                <button class="btn-small" onclick="clearFilters('polymarket')">Clear</button>
            </div>
        </div>
        <div class="events-list" id="polymarketEventsList">
            {% for event in poly_events %}
            <div class="event-item" data-id="{{ event.id }}" onclick="selectEvent(this, 'polymarket')">
                <div class="event-title">
                    {% if event.url %}
                        <a href="{{ event.url }}" target="_blank" onclick="event.stopPropagation()">{{ event.title }}</a>
                    {% else %}
                        {{ event.title }}
                    {% endif %}
                </div>
                {% if event.sub_title %}<div class="event-subtitle">{{ event.sub_title }}</div>{% endif %}
                {% if event.rules_primary %}<div class="event-rules">{{ event.rules_primary|truncatechars:150 }}</div>{% endif %}
                <div class="event-meta">
                    <span>24h Vol: ${{ event.volume_24h|floatformat:0 }}</span>
                    <span>Liq: ${{ event.liquidity|floatformat:0 }}</span>
                    {% if event.end_date %}<span>Ends: {{ event.end_date|slice:":10" }}</span>{% endif %}
                </div>
            </div>
            {% empty %}
            <p class="no-events">No Polymarket events synced yet. Click "Sync Events" to fetch them.</p>
            {% endfor %}
        </div>
    </div>
</div>

<div class="manual-event-match-section">
    <button class="btn primary" onclick="createEventMatch()" id="createEventMatchBtn" disabled>
        Create Event Match
        <span class="loading" id="createEventMatchLoading">...</span>
    </button>
    <span class="help-text" id="selectedEventsInfo">Select one event from each exchange</span>
</div>

<!-- Event Matches Table -->
<div class="section-header">
    <h2>Event Matches</h2>
    <span class="page-info">{{ total_event_matches }} total</span>
</div>

{% if event_matches %}
<table>
    <thead>
        <tr>
            <th>Kalshi Event</th>
            <th>Polymarket Event</th>
            <th class="sortable {% if current_sort == 'similarity_score' %}asc{% elif current_sort == '-similarity_score' %}desc{% endif %}"
                onclick="sortBy('similarity_score')">Score</th>
            <th class="sortable {% if current_sort == 'is_verified' %}asc{% elif current_sort == '-is_verified' %}desc{% endif %}"
                onclick="sortBy('is_verified')">Verified</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for match in event_matches %}
        <tr data-match-id="{{ match.id }}">
            <td class="event-cell">
                {% if match.kalshi_event.url %}
                    <a href="{{ match.kalshi_event.url }}" target="_blank">{{ match.kalshi_event.title|truncatechars:60 }}</a>
                {% else %}
                    {{ match.kalshi_event.title|truncatechars:60 }}
                {% endif %}
            </td>
            <td class="event-cell">
                {% if match.polymarket_event.url %}
                    <a href="{{ match.polymarket_event.url }}" target="_blank">{{ match.polymarket_event.title|truncatechars:60 }}</a>
                {% else %}
                    {{ match.polymarket_event.title|truncatechars:60 }}
                {% endif %}
            </td>
            <td class="score-cell">
                <span class="score-badge {% if match.similarity_score >= 0.7 %}high{% elif match.similarity_score >= 0.5 %}medium{% else %}low{% endif %}">
                    {{ match.similarity_score|floatformat:2 }}
                </span>
            </td>
            <td>
                <span class="verified-badge {% if match.is_verified %}verified{% else %}unverified{% endif %}">
                    {{ match.is_verified|yesno:"Yes,No" }}
                </span>
            </td>
            <td class="actions-cell">
                <button class="btn-small" onclick="verifyEventMatch({{ match.id }})">
                    {% if match.is_verified %}Unverify{% else %}Verify{% endif %}
                </button>
                <button class="btn-small danger" onclick="deleteEventMatch({{ match.id }})">&times;</button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Pagination -->
{% if event_matches.has_other_pages %}
<div class="pagination">
    {% if event_matches.has_previous %}
    <a href="?page=1&sort={{ current_sort }}">First</a>
    <a href="?page={{ event_matches.previous_page_number }}&sort={{ current_sort }}">Prev</a>
    {% else %}
    <span class="disabled">First</span>
    <span class="disabled">Prev</span>
    {% endif %}

    {% for num in event_matches.paginator.page_range %}
        {% if event_matches.number == num %}
        <span class="current">{{ num }}</span>
        {% elif num > event_matches.number|add:'-3' and num < event_matches.number|add:'3' %}
        <a href="?page={{ num }}&sort={{ current_sort }}">{{ num }}</a>
        {% endif %}
    {% endfor %}

    {% if event_matches.has_next %}
    <a href="?page={{ event_matches.next_page_number }}&sort={{ current_sort }}">Next</a>
    <a href="?page={{ event_matches.paginator.num_pages }}&sort={{ current_sort }}">Last</a>
    {% else %}
    <span class="disabled">Next</span>
    <span class="disabled">Last</span>
    {% endif %}
</div>
{% endif %}

{% else %}
<div class="empty-state">
    <p>No event matches found.</p>
    <p>Sync events first, then select one event from each exchange and click "Create Event Match".</p>
</div>
{% endif %}

<style>
    .section-description {
        color: #888;
        font-size: 14px;
        margin-bottom: 16px;
    }

    .events-display {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin: 20px 0;
    }

    .events-column {
        background: #1a1a1a;
        border-radius: 8px;
        padding: 16px;
    }

    .events-column h3 {
        margin-top: 0;
        margin-bottom: 12px;
        color: #fff;
        font-size: 16px;
    }

    .search-input {
        width: 100%;
        padding: 8px 12px;
        background: #2a2a2a;
        border: 1px solid #333;
        border-radius: 4px;
        color: #fff;
        margin-bottom: 12px;
        box-sizing: border-box;
    }

    .events-list {
        max-height: 400px;
        overflow-y: auto;
    }

    .event-item {
        padding: 12px;
        background: #222;
        border-radius: 6px;
        margin-bottom: 8px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: border-color 0.2s, background 0.2s;
    }

    .event-item:hover {
        background: #2a2a2a;
    }

    .event-item.selected {
        border-color: #22c55e;
        background: #1a2a1a;
    }

    .event-title {
        font-size: 14px;
        margin-bottom: 6px;
        line-height: 1.4;
    }

    .event-title a {
        color: #60a5fa;
        text-decoration: none;
    }

    .event-title a:hover {
        text-decoration: underline;
    }

    .event-meta {
        display: flex;
        gap: 12px;
        font-size: 12px;
        color: #666;
    }

    .event-subtitle {
        font-size: 12px;
        color: #888;
        margin-bottom: 4px;
    }

    .event-rules {
        font-size: 11px;
        color: #666;
        margin-bottom: 6px;
        line-height: 1.3;
        font-style: italic;
    }

    .filter-section {
        background: #2a2a2a;
        border-radius: 6px;
        padding: 10px;
        margin-bottom: 12px;
    }

    .filter-row {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
    }

    .filter-row:last-of-type {
        margin-bottom: 8px;
    }

    .filter-input {
        flex: 1;
        padding: 6px 8px;
        background: #333;
        border: 1px solid #444;
        border-radius: 4px;
        color: #fff;
        font-size: 12px;
    }

    .filter-input::placeholder {
        color: #666;
    }

    .filter-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
    }

    .event-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 8px;
    }

    .event-title-area {
        flex: 1;
    }

    .expand-btn {
        width: 24px;
        height: 24px;
        padding: 0;
        background: #333;
        border: 1px solid #444;
        border-radius: 4px;
        color: #fff;
        cursor: pointer;
        font-size: 16px;
        line-height: 1;
        flex-shrink: 0;
    }

    .expand-btn:hover {
        background: #444;
    }

    .market-count {
        color: #60a5fa;
        font-weight: 500;
    }

    .markets-container {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #333;
    }

    .market-item {
        background: #1a1a1a;
        border-radius: 4px;
        padding: 8px 10px;
        margin-bottom: 6px;
    }

    .market-item:last-child {
        margin-bottom: 0;
    }

    .market-title {
        font-size: 12px;
        color: #ccc;
        margin-bottom: 4px;
    }

    .market-outcomes {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 6px;
    }

    .outcome {
        background: #2a2a2a;
        padding: 2px 8px;
        border-radius: 3px;
        font-size: 11px;
        color: #22c55e;
    }

    .market-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        font-size: 11px;
        color: #666;
    }

    .no-markets {
        color: #666;
        font-size: 12px;
        font-style: italic;
    }

    .manual-event-match-section {
        display: flex;
        align-items: center;
        gap: 16px;
        margin: 16px 0;
        padding: 16px;
        background: #1a1a1a;
        border-radius: 8px;
    }

    .event-cell {
        max-width: 300px;
    }

    .event-cell a {
        color: #60a5fa;
        text-decoration: none;
    }

    .event-cell a:hover {
        text-decoration: underline;
    }

    .verified-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
    }

    .verified-badge.verified {
        background: #14532d;
        color: #22c55e;
    }

    .verified-badge.unverified {
        background: #333;
        color: #888;
    }

    .actions-cell {
        white-space: nowrap;
    }

    .no-events {
        color: #666;
        font-style: italic;
    }

    @media (max-width: 900px) {
        .events-display {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    const currentSort = '{{ current_sort }}';
    let selectedKalshiEvent = null;
    let selectedPolymarketEvent = null;
    let expandedEvents = new Set();  // Track expanded events

    // Debounce timers for each exchange
    const debounceTimers = { kalshi: null, polymarket: null };
    const DEBOUNCE_DELAY = 300;

    function sortBy(column) {
        let newSort = column;
        if (currentSort === column) {
            newSort = '-' + column;
        } else if (currentSort === '-' + column) {
            newSort = column;
        } else {
            newSort = '-' + column;
        }
        window.location.href = '?sort=' + newSort;
    }

    // Debounced filter function
    function debouncedApplyFilters(exchange) {
        if (debounceTimers[exchange]) {
            clearTimeout(debounceTimers[exchange]);
        }
        debounceTimers[exchange] = setTimeout(() => {
            applyFilters(exchange);
        }, DEBOUNCE_DELAY);
    }

    // Setup live search listeners on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Search inputs
        ['kalshi', 'polymarket'].forEach(exchange => {
            const searchInput = document.getElementById(`${exchange}EventSearch`);
            if (searchInput) {
                searchInput.addEventListener('input', () => debouncedApplyFilters(exchange));
            }

            // Filter inputs - trigger on change for numeric/date inputs
            const filterIds = [
                `${exchange}Volume24hMin`, `${exchange}Volume24hMax`,
                `${exchange}LiquidityMin`, `${exchange}LiquidityMax`,
                `${exchange}EndDateAfter`, `${exchange}EndDateBefore`
            ];
            filterIds.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('change', () => debouncedApplyFilters(exchange));
                    input.addEventListener('input', () => debouncedApplyFilters(exchange));
                }
            });
        });
    });

    // Event selection (on the header area, not expand)
    function selectEvent(element, exchange, e) {
        // Don't select if clicking on expand button or link
        if (e && (e.target.closest('.expand-btn') || e.target.closest('a'))) {
            return;
        }

        const eventId = element.dataset.id;

        if (exchange === 'kalshi') {
            if (selectedKalshiEvent === eventId) {
                selectedKalshiEvent = null;
                element.classList.remove('selected');
            } else {
                document.querySelectorAll('#kalshiEventsList .event-item.selected').forEach(el => {
                    el.classList.remove('selected');
                });
                selectedKalshiEvent = eventId;
                element.classList.add('selected');
            }
        } else {
            if (selectedPolymarketEvent === eventId) {
                selectedPolymarketEvent = null;
                element.classList.remove('selected');
            } else {
                document.querySelectorAll('#polymarketEventsList .event-item.selected').forEach(el => {
                    el.classList.remove('selected');
                });
                selectedPolymarketEvent = eventId;
                element.classList.add('selected');
            }
        }

        updateEventMatchButton();
    }

    // Toggle event expansion to show markets
    function toggleEventExpand(eventId, exchange) {
        const key = `${exchange}-${eventId}`;
        const marketsContainer = document.getElementById(`markets-${eventId}`);
        const expandBtn = document.querySelector(`[data-event-id="${eventId}"] .expand-btn`);

        if (expandedEvents.has(key)) {
            expandedEvents.delete(key);
            if (marketsContainer) marketsContainer.style.display = 'none';
            if (expandBtn) expandBtn.textContent = '+';
        } else {
            expandedEvents.add(key);
            if (marketsContainer) marketsContainer.style.display = 'block';
            if (expandBtn) expandBtn.textContent = '-';
        }
    }

    function updateEventMatchButton() {
        const btn = document.getElementById('createEventMatchBtn');
        const info = document.getElementById('selectedEventsInfo');

        if (selectedKalshiEvent && selectedPolymarketEvent) {
            btn.disabled = false;
            info.textContent = 'Ready to create match';
            info.style.color = '#22c55e';
        } else if (selectedKalshiEvent) {
            btn.disabled = true;
            info.textContent = 'Select a Polymarket event';
            info.style.color = '#888';
        } else if (selectedPolymarketEvent) {
            btn.disabled = true;
            info.textContent = 'Select a Kalshi event';
            info.style.color = '#888';
        } else {
            btn.disabled = true;
            info.textContent = 'Select one event from each exchange';
            info.style.color = '#888';
        }
    }

    // Truncate text helper
    function truncateText(text, maxLength) {
        if (!text) return '';
        return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    }

    // Format number as currency
    function formatCurrency(num) {
        if (num === null || num === undefined) return '$0';
        return '$' + Math.round(num).toLocaleString();
    }

    // Format price (0-1 range)
    function formatPrice(price) {
        if (price === null || price === undefined) return '-';
        const pct = (parseFloat(price) * 100).toFixed(0);
        return `${pct}Â¢`;
    }

    // Render markets list for an event
    function renderMarkets(markets, exchange) {
        if (!markets || markets.length === 0) {
            return '<div class="no-markets">No markets</div>';
        }

        return markets.map(market => {
            // Parse outcomes
            let outcomes = market.outcomes || [];
            if (typeof outcomes === 'string') {
                try { outcomes = JSON.parse(outcomes); } catch(e) { outcomes = []; }
            }

            // Format outcomes display
            let outcomesHtml = '';
            if (outcomes.length > 0) {
                outcomesHtml = outcomes.map(o => {
                    const name = o.name || o;
                    const price = o.price !== undefined ? formatPrice(o.price) : '';
                    return `<span class="outcome">${name}${price ? `: ${price}` : ''}</span>`;
                }).join('');
            }

            return `
                <div class="market-item">
                    <div class="market-title">${market.title || 'Untitled Market'}</div>
                    ${outcomesHtml ? `<div class="market-outcomes">${outcomesHtml}</div>` : ''}
                    <div class="market-meta">
                        <span>Vol: ${formatCurrency(market.volume)}</span>
                        <span>24h: ${formatCurrency(market.volume_24h)}</span>
                        <span>Liq: ${formatCurrency(market.liquidity)}</span>
                        ${market.close_time ? `<span>Closes: ${market.close_time.slice(0, 10)}</span>` : ''}
                    </div>
                </div>
            `;
        }).join('');
    }

    // Render events list
    function renderEventsList(exchange, events) {
        const listId = exchange === 'kalshi' ? 'kalshiEventsList' : 'polymarketEventsList';
        const countId = exchange === 'kalshi' ? 'kalshiCount' : 'polymarketCount';
        const eventsList = document.getElementById(listId);

        document.getElementById(countId).textContent = events.length;

        if (events.length === 0) {
            eventsList.innerHTML = '<p class="no-events">No events found matching your filters.</p>';
            return;
        }

        eventsList.innerHTML = events.map(event => {
            const key = `${exchange}-${event.id}`;
            const isExpanded = expandedEvents.has(key);
            const hasMarkets = event.markets && event.markets.length > 0;

            return `
                <div class="event-item" data-id="${event.id}" data-event-id="${event.id}" onclick="selectEvent(this, '${exchange}', event)">
                    <div class="event-header">
                        <div class="event-title-area">
                            <div class="event-title">
                                ${event.url
                                    ? `<a href="${event.url}" target="_blank" onclick="event.stopPropagation()">${event.title}</a>`
                                    : event.title}
                            </div>
                            ${event.sub_title ? `<div class="event-subtitle">${event.sub_title}</div>` : ''}
                        </div>
                        ${hasMarkets ? `
                            <button class="expand-btn" onclick="event.stopPropagation(); toggleEventExpand(${event.id}, '${exchange}')">${isExpanded ? '-' : '+'}</button>
                        ` : ''}
                    </div>
                    ${event.rules_primary ? `<div class="event-rules">${truncateText(event.rules_primary, 150)}</div>` : ''}
                    <div class="event-meta">
                        <span>24h Vol: ${formatCurrency(event.volume_24h)}</span>
                        <span>Liq: ${formatCurrency(event.liquidity)}</span>
                        ${event.end_date ? `<span>Ends: ${event.end_date.slice(0, 10)}</span>` : ''}
                        ${hasMarkets ? `<span class="market-count">${event.markets.length} market${event.markets.length !== 1 ? 's' : ''}</span>` : ''}
                    </div>
                    ${hasMarkets ? `
                        <div class="markets-container" id="markets-${event.id}" style="display: ${isExpanded ? 'block' : 'none'}">
                            ${renderMarkets(event.markets, exchange)}
                        </div>
                    ` : ''}
                </div>
            `;
        }).join('');

        // Re-select previously selected event if still in list
        if (exchange === 'kalshi' && selectedKalshiEvent) {
            const el = eventsList.querySelector(`[data-id="${selectedKalshiEvent}"]`);
            if (el) el.classList.add('selected');
        } else if (exchange === 'polymarket' && selectedPolymarketEvent) {
            const el = eventsList.querySelector(`[data-id="${selectedPolymarketEvent}"]`);
            if (el) el.classList.add('selected');
        }
    }

    // Apply filters and fetch events from API
    async function applyFilters(exchange) {
        const searchInput = document.getElementById(exchange === 'kalshi' ? 'kalshiEventSearch' : 'polymarketEventSearch');
        const params = new URLSearchParams();

        params.append('exchange', exchange);
        params.append('limit', '100');
        params.append('include_markets', 'true');

        const search = searchInput.value.trim();
        if (search) params.append('search', search);

        // Get filter values
        const volume24hMin = document.getElementById(`${exchange}Volume24hMin`).value;
        const volume24hMax = document.getElementById(`${exchange}Volume24hMax`).value;
        const liquidityMin = document.getElementById(`${exchange}LiquidityMin`).value;
        const liquidityMax = document.getElementById(`${exchange}LiquidityMax`).value;
        const endDateAfter = document.getElementById(`${exchange}EndDateAfter`).value;
        const endDateBefore = document.getElementById(`${exchange}EndDateBefore`).value;

        if (volume24hMin) params.append('volume_24h_min', volume24hMin);
        if (volume24hMax) params.append('volume_24h_max', volume24hMax);
        if (liquidityMin) params.append('liquidity_min', liquidityMin);
        if (liquidityMax) params.append('liquidity_max', liquidityMax);
        if (endDateAfter) params.append('end_date_after', endDateAfter);
        if (endDateBefore) params.append('end_date_before', endDateBefore);

        try {
            const response = await fetch(`/api/events/?${params.toString()}`);
            const data = await response.json();

            if (data.success) {
                renderEventsList(exchange, data.events);
            } else {
                showToast('Error: ' + data.error, 'error');
            }
        } catch (e) {
            showToast('Network error: ' + e.message, 'error');
        }
    }

    // Clear filters for an exchange
    function clearFilters(exchange) {
        document.getElementById(`${exchange}EventSearch`).value = '';
        document.getElementById(`${exchange}Volume24hMin`).value = '';
        document.getElementById(`${exchange}Volume24hMax`).value = '';
        document.getElementById(`${exchange}LiquidityMin`).value = '';
        document.getElementById(`${exchange}LiquidityMax`).value = '';
        document.getElementById(`${exchange}EndDateAfter`).value = '';
        document.getElementById(`${exchange}EndDateBefore`).value = '';
        applyFilters(exchange);
    }

    // Create manual event match
    async function createEventMatch() {
        if (!selectedKalshiEvent || !selectedPolymarketEvent) return;

        const btn = document.getElementById('createEventMatchBtn');
        const loading = document.getElementById('createEventMatchLoading');

        btn.disabled = true;
        loading.style.display = 'inline';

        try {
            const response = await fetch('/api/event-matches/create/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    kalshi_event_id: selectedKalshiEvent,
                    polymarket_event_id: selectedPolymarketEvent
                })
            });

            const data = await response.json();

            if (data.success) {
                showToast('Event match created');
                setTimeout(() => location.reload(), 500);
            } else {
                showToast('Error: ' + data.error, 'error');
            }
        } catch (e) {
            showToast('Network error: ' + e.message, 'error');
        } finally {
            btn.disabled = false;
            loading.style.display = 'none';
        }
    }

    // Verify event match
    async function verifyEventMatch(matchId) {
        try {
            const response = await fetch(`/api/event-matches/${matchId}/verify/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                }
            });

            const data = await response.json();

            if (data.success) {
                location.reload();
            } else {
                showToast('Error: ' + data.error, 'error');
            }
        } catch (e) {
            showToast('Network error: ' + e.message, 'error');
        }
    }

    // Delete event match
    async function deleteEventMatch(matchId) {
        if (!confirm('Delete this event match?')) return;

        try {
            const response = await fetch(`/api/event-matches/${matchId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                }
            });

            const data = await response.json();

            if (data.success) {
                showToast('Event match deleted');
                setTimeout(() => location.reload(), 500);
            } else {
                showToast('Error: ' + data.error, 'error');
            }
        } catch (e) {
            showToast('Network error: ' + e.message, 'error');
        }
    }

    function clearSyncFilters() {
        document.getElementById('closeAfterDate').value = '';
    }

    async function syncEvents() {
        const btn = document.getElementById('syncBtn');
        const loading = document.getElementById('syncLoading');

        btn.disabled = true;
        loading.style.display = 'inline';

        try {
            const closeAfter = document.getElementById('closeAfterDate').value;

            const body = {};
            if (closeAfter) {
                body.close_after = closeAfter;
            }

            const response = await fetch('{% url "markets:sync_markets" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });

            const data = await response.json();

            if (data.success) {
                showToast(`Synced: ${data.kalshi_synced} Kalshi, ${data.polymarket_synced} Polymarket events`);
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast('Error: ' + data.error, 'error');
            }
        } catch (e) {
            showToast('Network error: ' + e.message, 'error');
        } finally {
            btn.disabled = false;
            loading.style.display = 'none';
        }
    }
</script>
{% endblock %}
