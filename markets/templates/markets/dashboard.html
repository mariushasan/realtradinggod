{% extends 'markets/base.html' %}
{% load static %}

{% block title %}Dashboard - Arbitrage Analyzer{% endblock %}

{% block content %}
<div class="stats-grid">
    <div class="stat-card">
        <h3>Opportunities</h3>
        <div class="value green">{{ total_opportunities }}</div>
    </div>
    <div class="stat-card">
        <h3>Kalshi Markets</h3>
        <div class="value">{{ kalshi_count }}</div>
    </div>
    <div class="stat-card">
        <h3>Polymarket Markets</h3>
        <div class="value">{{ poly_count }}</div>
    </div>
    <div class="stat-card">
        <h3>Cross-Exchange Matches</h3>
        <div class="value">{{ match_count }}</div>
    </div>
</div>

<div class="section-header">
    <h2>Tag Filters</h2>
    <button class="btn" onclick="refreshTags()" id="refreshTagsBtn">
        Refresh Tags from API
        <span class="loading" id="refreshTagsLoading">...</span>
    </button>
</div>

<div class="tag-filters">
    <div class="tag-filter-section">
        <div class="tag-section-header">
            <h3>Kalshi Tags</h3>
            <label class="select-all-checkbox">
                <input type="checkbox" id="kalshiSelectAll" onchange="toggleAllKalshi(this.checked)">
                <span>Select All</span>
            </label>
        </div>
        <div class="tag-select-container" id="kalshiTagsContainer">
            <div class="tag-checkboxes" id="kalshiTags">
                {% if kalshi_tags_by_category %}
                    {% for category, tags in kalshi_tags_by_category.items %}
                    <div class="tag-category">
                        <span class="category-label">{{ category }}</span>
                        <div class="category-tags">
                            {% for tag in tags %}
                            <label class="tag-checkbox">
                                <input type="checkbox" name="kalshi_tag" value="{{ tag.slug }}" data-label="{{ tag.label }}" data-tag-id="{{ tag.id }}">
                                <span class="tag-label">{{ tag.label }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <span class="no-tags">No tags available. Click "Refresh Tags from API" to fetch them.</span>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="tag-filter-section">
        <div class="tag-section-header">
            <h3>Polymarket Tags</h3>
            <label class="select-all-checkbox">
                <input type="checkbox" id="polymarketSelectAll" onchange="toggleAllPolymarket(this.checked)">
                <span>Select All</span>
            </label>
        </div>
        <div class="tag-select-container" id="polymarketTagsContainer">
            <div class="tag-checkboxes" id="polymarketTags">
                {% if polymarket_tags %}
                <div class="category-tags">
                    {% for tag in polymarket_tags %}
                    <label class="tag-checkbox">
                        <input type="checkbox" name="polymarket_tag" value="{{ tag.external_id }}" data-label="{{ tag.label }}" data-tag-id="{{ tag.id }}">
                        <span class="tag-label">{{ tag.label }}</span>
                    </label>
                    {% endfor %}
                </div>
                {% else %}
                    <span class="no-tags">No tags available. Click "Refresh Tags from API" to fetch them.</span>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Manual Tag Match Button -->
<div class="manual-match-section">
    <button class="btn" onclick="createManualTagMatch()" id="manualMatchBtn">
        Create Manual Tag Match
        <span class="loading" id="manualMatchLoading">...</span>
    </button>
    <span class="help-text">Select one tag from Kalshi and one from Polymarket above, then click to create a match</span>
</div>

<!-- Matched Tags Section -->
<div class="section-header">
    <h2>Matched Tags</h2>
    <span class="page-info">{{ tag_match_count }} matches</span>
</div>

<div class="matched-tags-section">
    {% if tag_matches %}
    <div class="matched-tags-container">
        <table class="matched-tags-table">
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAllMatches" onchange="toggleAllMatches(this.checked)"></th>
                    <th>Kalshi Tag</th>
                    <th>Polymarket Tag</th>
                    <th>Score</th>
                    <th>Reason</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for match in tag_matches %}
                <tr class="tag-match-row {% if match.is_manual %}manual-match{% endif %}">
                    <td>
                        <input type="checkbox"
                               name="tag_match"
                               value="{{ match.id }}"
                               data-kalshi-slug="{{ match.kalshi_tag.slug }}"
                               data-polymarket-id="{{ match.polymarket_tag.external_id }}">
                    </td>
                    <td>
                        <span class="tag-badge kalshi">
                            {% if match.kalshi_tag.category %}{{ match.kalshi_tag.category }}: {% endif %}{{ match.kalshi_tag.label }}
                        </span>
                    </td>
                    <td>
                        <span class="tag-badge polymarket">{{ match.polymarket_tag.label }}</span>
                    </td>
                    <td class="score-cell">
                        <span class="score-badge {% if match.similarity_score >= 0.7 %}high{% elif match.similarity_score >= 0.5 %}medium{% else %}low{% endif %}">
                            {{ match.similarity_score|floatformat:2 }}
                        </span>
                    </td>
                    <td class="reason-cell">{{ match.match_reason|truncatechars:50 }}</td>
                    <td>
                        {% if match.is_manual %}
                        <span class="badge manual">Manual</span>
                        {% endif %}
                        <button class="btn-small danger" onclick="deleteTagMatch({{ match.id }})" title="Delete match">
                            &times;
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <p>No tag matches found.</p>
        <p>Click "Refresh Tags from API" to automatically find semantic matches between Kalshi and Polymarket tags.</p>
    </div>
    {% endif %}
</div>

<div class="section-header">
    <h2>Actions</h2>
    <div>
        <button class="btn primary" onclick="syncMarkets()" id="syncBtn">
            Sync Markets
            <span class="loading" id="syncLoading">...</span>
        </button>
        <button class="btn" onclick="refreshOpportunities()" id="refreshBtn">
            Refresh Opportunities
            <span class="loading" id="refreshLoading">...</span>
        </button>
        <button class="btn secondary" onclick="syncFromMatchedTags()" id="syncMatchedBtn">
            Sync from Matched Tags
            <span class="loading" id="syncMatchedLoading">...</span>
        </button>
    </div>
</div>

<div class="section-header">
    <h2>All Arbitrage Opportunities</h2>
    <span class="page-info">{{ total_opportunities }} total</span>
</div>

{% if opportunities %}
<table>
    <thead>
        <tr>
            <th>Kalshi Market</th>
            <th>Polymarket Market</th>
            <th>Positions</th>
            <th class="sortable {% if current_sort == 'profit_percent' %}asc{% elif current_sort == '-profit_percent' %}desc{% endif %}"
                onclick="sortBy('profit_percent')">Profit %</th>
            <th class="sortable {% if current_sort == 'expected_value' %}asc{% elif current_sort == '-expected_value' %}desc{% endif %}"
                onclick="sortBy('expected_value')">EV</th>
            <th class="sortable {% if current_sort == 'arb_type' %}asc{% elif current_sort == '-arb_type' %}desc{% endif %}"
                onclick="sortBy('arb_type')">Type</th>
        </tr>
    </thead>
    <tbody>
        {% for opp in opportunities %}
        <tr>
            {% if opp.arb_type == 'cross_exchange' %}
            <td>
                <a href="{{ opp.market_match.kalshi_market.url }}" target="_blank">
                    {{ opp.market_match.kalshi_market.title|truncatechars:50 }}
                </a>
            </td>
            <td>
                <a href="{{ opp.market_match.polymarket_market.url }}" target="_blank">
                    {{ opp.market_match.polymarket_market.title|truncatechars:50 }}
                </a>
            </td>
            {% elif opp.arb_type == 'kalshi_only' %}
            <td>
                {% for market in opp.markets.all %}
                <a href="{{ market.url }}" target="_blank">
                    {{ market.title|truncatechars:50 }}
                </a>
                {% endfor %}
            </td>
            <td class="same-exchange">
                <span class="badge kalshi">Same exchange (Kalshi)</span>
            </td>
            {% elif opp.arb_type == 'polymarket_only' %}
            <td class="same-exchange">
                <span class="badge polymarket">Same exchange (Polymarket)</span>
            </td>
            <td>
                {% for market in opp.markets.all %}
                <a href="{{ market.url }}" target="_blank">
                    {{ market.title|truncatechars:50 }}
                </a>
                {% endfor %}
            </td>
            {% endif %}
            <td class="positions-list">
                {% for pos in opp.positions.positions %}
                <div class="position">
                    {% if opp.arb_type == 'cross_exchange' %}
                    <span class="exchange-badge {{ pos.exchange }}">{{ pos.exchange }}</span>
                    {% endif %}
                    {{ pos.outcome }} @ {{ pos.price|floatformat:2 }}
                </div>
                {% endfor %}
            </td>
            <td class="profit {% if opp.profit_percent > 5 %}high{% endif %}">
                +{{ opp.profit_percent|floatformat:2 }}%
            </td>
            <td>{{ opp.expected_value|floatformat:3 }}</td>
            <td>
                {% if opp.arb_type == 'cross_exchange' %}
                <span class="type-badge cross">Cross</span>
                {% if opp.market_match.is_verified %}
                <span style="color: #22c55e; font-size: 0.8em;">âœ“</span>
                {% endif %}
                {% elif opp.arb_type == 'kalshi_only' %}
                <span class="type-badge kalshi">Kalshi</span>
                {% else %}
                <span class="type-badge poly">Poly</span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Pagination -->
{% if opportunities.has_other_pages %}
<div class="pagination">
    {% if opportunities.has_previous %}
    <a href="?page=1&sort={{ current_sort }}">First</a>
    <a href="?page={{ opportunities.previous_page_number }}&sort={{ current_sort }}">Prev</a>
    {% else %}
    <span class="disabled">First</span>
    <span class="disabled">Prev</span>
    {% endif %}

    {% for num in opportunities.paginator.page_range %}
        {% if opportunities.number == num %}
        <span class="current">{{ num }}</span>
        {% elif num > opportunities.number|add:'-3' and num < opportunities.number|add:'3' %}
        <a href="?page={{ num }}&sort={{ current_sort }}">{{ num }}</a>
        {% endif %}
    {% endfor %}

    {% if opportunities.has_next %}
    <a href="?page={{ opportunities.next_page_number }}&sort={{ current_sort }}">Next</a>
    <a href="?page={{ opportunities.paginator.num_pages }}&sort={{ current_sort }}">Last</a>
    {% else %}
    <span class="disabled">Next</span>
    <span class="disabled">Last</span>
    {% endif %}
</div>
{% endif %}

{% else %}
<div class="empty-state">
    <p>No arbitrage opportunities found.</p>
    <p>Select tags above and click "Sync Markets" to fetch data from exchanges.</p>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    const currentSort = '{{ current_sort }}';

    function sortBy(column) {
        let newSort = column;
        if (currentSort === column) {
            newSort = '-' + column;
        } else if (currentSort === '-' + column) {
            newSort = column;
        } else {
            newSort = '-' + column;
        }
        window.location.href = '?sort=' + newSort;
    }

    function toggleAllKalshi(checked) {
        document.querySelectorAll('input[name="kalshi_tag"]').forEach(cb => {
            cb.checked = checked;
        });
    }

    function toggleAllPolymarket(checked) {
        document.querySelectorAll('input[name="polymarket_tag"]').forEach(cb => {
            cb.checked = checked;
        });
    }

    function updateSelectAllState() {
        // Update Kalshi select all
        const kalshiCheckboxes = document.querySelectorAll('input[name="kalshi_tag"]');
        const kalshiChecked = document.querySelectorAll('input[name="kalshi_tag"]:checked');
        const kalshiSelectAll = document.getElementById('kalshiSelectAll');
        if (kalshiSelectAll) {
            kalshiSelectAll.checked = kalshiCheckboxes.length > 0 && kalshiCheckboxes.length === kalshiChecked.length;
        }

        // Update Polymarket select all
        const polyCheckboxes = document.querySelectorAll('input[name="polymarket_tag"]');
        const polyChecked = document.querySelectorAll('input[name="polymarket_tag"]:checked');
        const polySelectAll = document.getElementById('polymarketSelectAll');
        if (polySelectAll) {
            polySelectAll.checked = polyCheckboxes.length > 0 && polyCheckboxes.length === polyChecked.length;
        }
    }

    // Add event listeners to individual checkboxes to update select all state
    document.querySelectorAll('input[name="kalshi_tag"], input[name="polymarket_tag"]').forEach(cb => {
        cb.addEventListener('change', updateSelectAllState);
    });

    async function refreshTags() {
        const btn = document.getElementById('refreshTagsBtn');
        const loading = document.getElementById('refreshTagsLoading');

        btn.disabled = true;
        loading.style.display = 'inline';

        try {
            const response = await fetch('{% url "markets:refresh_tags" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                }
            });

            const data = await response.json();

            if (data.success) {
                const matchMsg = data.tag_matches_found ? `, ${data.tag_matches_found} tag matches found` : '';
                showToast(`Synced ${data.kalshi_synced} Kalshi tags, ${data.polymarket_synced} Polymarket tags${matchMsg}. Reloading...`);
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('Error refreshing tags: ' + data.error, 'error');
            }
        } catch (e) {
            showToast('Network error: ' + e.message, 'error');
        } finally {
            btn.disabled = false;
            loading.style.display = 'none';
        }
    }

    function toggleAllMatches(checked) {
        document.querySelectorAll('input[name="tag_match"]').forEach(cb => {
            cb.checked = checked;
        });
    }

    function getSelectedSingleTags() {
        // Get selected single tags (for manual matching - only one from each)
        const kalshiChecked = document.querySelectorAll('input[name="kalshi_tag"]:checked');
        const polyChecked = document.querySelectorAll('input[name="polymarket_tag"]:checked');

        return {
            kalshiTag: kalshiChecked.length === 1 ? {
                id: kalshiChecked[0].closest('label').querySelector('input').dataset.id || kalshiChecked[0].value,
                label: kalshiChecked[0].dataset.label
            } : null,
            polymarketTag: polyChecked.length === 1 ? {
                id: polyChecked[0].closest('label').querySelector('input').dataset.id || polyChecked[0].value,
                label: polyChecked[0].dataset.label
            } : null,
            kalshiCount: kalshiChecked.length,
            polymarketCount: polyChecked.length
        };
    }

    async function createManualTagMatch() {
        const btn = document.getElementById('manualMatchBtn');
        const loading = document.getElementById('manualMatchLoading');

        // Get the selected single tags with their database IDs
        const kalshiChecked = document.querySelectorAll('input[name="kalshi_tag"]:checked');
        const polyChecked = document.querySelectorAll('input[name="polymarket_tag"]:checked');

        if (kalshiChecked.length !== 1 || polyChecked.length !== 1) {
            showToast('Please select exactly one Kalshi tag and one Polymarket tag to create a manual match.', 'error');
            return;
        }

        // Get the tag IDs from data attributes
        const kalshiTagId = kalshiChecked[0].dataset.tagId;
        const polymarketTagId = polyChecked[0].dataset.tagId;

        if (!kalshiTagId || !polymarketTagId) {
            showToast('Could not find tag IDs. Please refresh the page and try again.', 'error');
            return;
        }

        btn.disabled = true;
        loading.style.display = 'inline';

        try {
            const response = await fetch('{% url "markets:create_tag_match" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    kalshi_tag_id: parseInt(kalshiTagId),
                    polymarket_tag_id: parseInt(polymarketTagId)
                })
            });

            const data = await response.json();

            if (data.success) {
                const action = data.created ? 'Created' : 'Updated';
                showToast(`${action} tag match: ${data.tag_match.kalshi_tag.label} <-> ${data.tag_match.polymarket_tag.label}`);
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('Error creating tag match: ' + data.error, 'error');
            }
        } catch (e) {
            showToast('Network error: ' + e.message, 'error');
        } finally {
            btn.disabled = false;
            loading.style.display = 'none';
        }
    }

    async function deleteTagMatch(matchId) {
        if (!confirm('Are you sure you want to delete this tag match?')) {
            return;
        }

        try {
            const response = await fetch(`/api/tag-matches/${matchId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                }
            });

            const data = await response.json();

            if (data.success) {
                showToast('Tag match deleted');
                setTimeout(() => location.reload(), 500);
            } else {
                showToast('Error deleting tag match: ' + data.error, 'error');
            }
        } catch (e) {
            showToast('Network error: ' + e.message, 'error');
        }
    }

    function getSelectedMatchedTags() {
        const kalshiSlugs = [];
        const polymarketIds = [];

        document.querySelectorAll('input[name="tag_match"]:checked').forEach(cb => {
            const kalshiSlug = cb.dataset.kalshiSlug;
            const polymarketId = cb.dataset.polymarketId;
            if (kalshiSlug && !kalshiSlugs.includes(kalshiSlug)) {
                kalshiSlugs.push(kalshiSlug);
            }
            if (polymarketId && !polymarketIds.includes(polymarketId)) {
                polymarketIds.push(polymarketId);
            }
        });

        return { kalshiSlugs, polymarketIds };
    }

    async function syncFromMatchedTags() {
        const { kalshiSlugs, polymarketIds } = getSelectedMatchedTags();

        if (kalshiSlugs.length === 0 && polymarketIds.length === 0) {
            showToast('Please select at least one matched tag pair to sync markets.', 'error');
            return;
        }

        const btn = document.getElementById('syncMatchedBtn');
        const loading = document.getElementById('syncMatchedLoading');

        btn.disabled = true;
        loading.style.display = 'inline';

        try {
            const body = {};
            if (kalshiSlugs.length > 0) {
                body.kalshi_tags = kalshiSlugs;
            }
            if (polymarketIds.length > 0) {
                body.polymarket_tags = polymarketIds;
            }

            const response = await fetch('{% url "markets:sync_markets" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });

            const data = await response.json();

            if (data.success) {
                showToast(`Synced from matched tags: ${data.kalshi_synced} Kalshi, ${data.polymarket_synced} Polymarket markets`);
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast('Error: ' + data.error, 'error');
            }
        } catch (e) {
            showToast('Network error: ' + e.message, 'error');
        } finally {
            btn.disabled = false;
            loading.style.display = 'none';
        }
    }

    function getSelectedTags() {
        const kalshiTags = [];
        const polymarketTags = [];

        document.querySelectorAll('input[name="kalshi_tag"]:checked').forEach(cb => {
            kalshiTags.push(cb.value);
        });

        document.querySelectorAll('input[name="polymarket_tag"]:checked').forEach(cb => {
            polymarketTags.push(cb.value);
        });

        return { kalshiTags, polymarketTags };
    }

    function validateTagSelection() {
        const { kalshiTags, polymarketTags } = getSelectedTags();
        if (kalshiTags.length === 0 && polymarketTags.length === 0) {
            showToast('Please select at least one tag to proceed.', 'error');
            return false;
        }
        return true;
    }

    async function syncMarkets() {
        if (!validateTagSelection()) return;

        const btn = document.getElementById('syncBtn');
        const loading = document.getElementById('syncLoading');

        btn.disabled = true;
        loading.style.display = 'inline';

        try {
            const { kalshiTags, polymarketTags } = getSelectedTags();

            const body = {};
            if (kalshiTags.length > 0) {
                body.kalshi_tags = kalshiTags;
            }
            if (polymarketTags.length > 0) {
                body.polymarket_tags = polymarketTags;
            }

            const response = await fetch('{% url "markets:sync_markets" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });

            const data = await response.json();

            if (data.success) {
                showToast(`Synced: ${data.kalshi_synced} Kalshi, ${data.polymarket_synced} Polymarket markets`);
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast('Error: ' + data.error, 'error');
            }
        } catch (e) {
            showToast('Network error: ' + e.message, 'error');
        } finally {
            btn.disabled = false;
            loading.style.display = 'none';
        }
    }

    async function refreshOpportunities() {
        if (!validateTagSelection()) return;

        const btn = document.getElementById('refreshBtn');
        const loading = document.getElementById('refreshLoading');

        btn.disabled = true;
        loading.style.display = 'inline';

        try {
            const { kalshiTags, polymarketTags } = getSelectedTags();

            const body = {};
            if (kalshiTags.length > 0) {
                body.kalshi_tags = kalshiTags;
            }
            if (polymarketTags.length > 0) {
                body.polymarket_tags = polymarketTags;
            }

            const response = await fetch('{% url "markets:refresh_arbitrage" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });

            const data = await response.json();

            if (data.success) {
                showToast(`Found ${data.matches_found} matches, ${data.opportunities_found} opportunities`);
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast('Error: ' + data.error, 'error');
            }
        } catch (e) {
            showToast('Network error: ' + e.message, 'error');
        } finally {
            btn.disabled = false;
            loading.style.display = 'none';
        }
    }
</script>
{% endblock %}
